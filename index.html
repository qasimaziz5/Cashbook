<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cashbook ‚Äî Full Latest Build</title>
<style>
:root{
  --bg:#f6f8fc; --panel:#ffffff; --card:#ffffff;
  --text:#0f172a; --muted:#64748b; --line:#e2e8f0;
  --green:#16a34a; --red:#ef4444; --accent:#22c55e;
  --radius:16px; --shadow:0 10px 24px rgba(15,23,42,.08);
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,Segoe UI,Roboto,Arial}
.app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
.sidebar{border-right:1px solid var(--line);padding:18px;position:sticky;top:0;height:100vh;background:var(--panel);color:var(--text)}
.brand{font-weight:800;margin-bottom:12px}
.nav button{width:100%;text-align:left;background:#f8fafc;border:1px solid var(--line);padding:12px 14px;border-radius:12px;margin:8px 0;cursor:pointer}
.nav button.active{background:#ebf8f1;border-color:#b7f4cd}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--panel);z-index:5}
.chip{background:#f1f5f9;border:1px solid var(--line);color:var(--muted);font-weight:600;border-radius:999px;padding:6px 10px}
.btn{border:1px solid var(--line);background:#f8fafc;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#06120d;font-weight:800}
.btn.gray{background:#f1f5f9;border-color:#e2e8f0}
.btn.red{background:#fef2f2;border-color:#fecaca}
.input{display:flex;align-items:center;border:1px solid var(--line);border-radius:12px;background:#ffffff;padding:16px 16px;color:var(--muted);font-size:16px}
.input input, .input select{background:transparent;border:none;outline:none;color:var(--text);font-size:16px;line-height:1.35}
.field input, .field select, .field textarea{padding:14px 12px;border:1px solid var(--line);border-radius:12px;font-size:16px;line-height:1.35}
.grid{display:grid;gap:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
.panel{box-shadow:var(--shadow)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
.value{font-size:24px;font-weight:800}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
.stat{background:#f8fafc;border:1px solid var(--line);border-radius:14px;padding:12px}
#statIn{color:var(--green);font-weight:800} #statOut{color:var(--red);font-weight:800}
.filters{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
.filter{border:1px solid var(--line);background:#ffffff;border-radius:12px;padding:10px 12px}
.meta{color:var(--muted);font-size:12px}
.right{text-align:right}
.amount-in{color:var(--green);font-weight:600}
.amount-out{color:var(--red);font-weight:600}
.hidden{display:none}

/* Login */
.login-hero{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:
radial-gradient(900px 600px at 20% 20%, #93c5fd66 0%, transparent 60%),
radial-gradient(900px 800px at 80% 30%, #86efac66 0%, transparent 55%),
linear-gradient(120deg, #eaf2ff 0%, #f7fafc 100%);z-index:99}
#loginCard{width:min(460px,92vw);background:#ffffff;border:1px solid #e2e8f0;border-radius:18px;box-shadow:0 10px 30px rgba(15,23,42,.08);padding:20px}
#loginCard h2{margin:0 0 6px}
#loginCard input{width:100%;padding:12px;border-radius:12px;border:1px solid #e2e8f0;background:#fff;color:#0f172a}
#loginCard input:focus{outline:none;border-color:#60a5fa;box-shadow:0 0 0 3px rgba(96,165,250,.25)}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:90}
.modal .sheet{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;width:min(760px,95vw)}

/* DatePicker */
.datepicker{position:fixed;z-index:120;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:8px;width:260px}
.dp-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.dp-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.dp-grid .dow{font-size:11px;color:var(--muted);text-align:center}
.dp-grid button{border:1px solid var(--line);background:#f8fafc;border-radius:8px;padding:6px 0;cursor:pointer}
.dp-grid button:hover{background:#eef2ff}
.dp-grid button.dp-today{outline:2px solid #a5b4fc}

/* Book title */
.book-title{margin-bottom:4px;font-size:18px;font-weight:800;cursor:pointer}

/* Colored button palettes */
.btn-green{background:#dcfce7;border-color:#86efac;color:#065f46}
.btn-solid-green{background:#16a34a;border-color:#16a34a;color:#06120d;font-weight:800}
.btn-red{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
.btn-solid-red{background:#ef4444;border-color:#ef4444;color:#0b0a0a;font-weight:800}
.btn-blue{background:#dbeafe;border-color:#bfdbfe;color:#1e3a8a}
.btn-solid-blue{background:#3b82f6;border-color:#3b82f6;color:#06121a;font-weight:800}
.btn-purple{background:#ede9fe;border-color:#ddd6fe;color:#4c1d95}
.btn-solid-purple{background:#a855f7;border-color:#a855f7;color:#0f1020;font-weight:800}
.btn-save{background:#3b82f6;border-color:#3b82f6;color:#06121a;font-weight:800}

@media print{
  body{background:#fff;color:#000}
  .sidebar,.topbar,#pageBooks,#pageUsers,#pageBackup,.filters,.toolbar{display:none!important}
  #printArea{display:block!important}
  .card,.panel{box-shadow:none;border:0}
}
</style>
</head>
<body>
<!-- Login -->
<div id="loginWrap" class="login-hero" style="display:flex">
  <div id="loginCard">
    <h2>Welcome back</h2>
    <p class="sub meta">Default admin: <b>admin / admin</b></p>
    <div class="grid">
      <div class="field"><label>Username</label><input id="loginUser" placeholder="admin" value="admin"/></div>
      <div class="field"><label>Password</label><input id="loginPass" type="password" placeholder="admin" value="admin" onkeydown="if(event.key==='Enter'){ return doLogin(); }"/></div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
      <a href="#" id="resetAppLink" class="meta">Reset App (clear data)</a>
    </div>
    <div class="actions">
      <button class="btn gray" id="loginBtn" onclick="return doLogin()">Sign In</button>
    </div>
  </div>
</div>

<div id="app" class="app" style="display:none">
  <aside class="sidebar">
    <div class="brand">Cashbook</div>
    <div class="nav">
      <button id="navBooks" class="active">üìö Books</button>
      <button id="navEntries">üìÑ Entries</button>
      <button id="navUsers">üë• Users</button>
      <button id="navBackup">üóÑÔ∏è Backup & Restore</button>
    </div>
  </aside>

  <main>
    <div class="topbar">
      <div class="toolbar">
        <span class="chip" id="welcomeText">Welcome</span>
        <span class="chip" id="roleChip">Your Role: <strong>Owner</strong></span>
      </div>
      <div class="toolbar">
        <div class="input" style="min-width:240px"><span>üè¢&nbsp;</span>
          <select id="businessSwitcher" style="font-weight:700;height:46px;"></select>
        </div>
        <button class="btn gray" id="addBusinessBtn">+ Add Business</button>
        <button class="btn gray" id="renameBusinessBtn" title="Rename business">‚úèÔ∏è Rename</button>
        <button class="btn red" id="deleteBusinessBtn" title="Delete business">üóëÔ∏è Delete</button>
        <button class="btn gray" id="logoutBtn" title="Sign out" style="padding:6px 10px;font-weight:700">Logout</button>
      </div>
    </div>

    <div class="content" style="padding:16px">
      <!-- BOOKS PAGE -->
      <section id="pageBooks">
        <div class="toolbar">
          <div class="input" style="min-width:260px"><span>üîé&nbsp;</span><input id="searchBooks" placeholder="Search by book name..."/></div>
          <div class="input"><span>üìï&nbsp;</span><input id="bookName" placeholder="New Book name"/></div>
          <button class="btn primary" id="createBook">Create Book</button>
        </div>
        <div id="booksList" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:10px"></div>
      </section>

      <!-- ENTRIES PAGE -->
      <section id="pageEntries" class="hidden">
        <div class="toolbar">
          <div class="input"><span>üìò&nbsp;</span><select id="bookSelector" style="font-weight:700;height:46px;"></select></div>
          <div class="input"><span>üîé&nbsp;</span><input id="searchEntries" placeholder="Search entries..."/></div>
          <div class="dates" style="display:flex;gap:6px;align-items:center">
            <div class="input"><span>üìÖ</span><input id="dateFrom" type="text" placeholder="DD-MM-YYYY"/></div>
            <div class="input"><span>üìÖ</span><input id="dateTo" type="text" placeholder="DD-MM-YYYY"/></div>
            <button class="btn primary" id="applyDate">Apply</button>
            <button class="btn gray" id="clearDate">Clear</button>
          </div>
          <button class="btn primary" id="btnAddEntry">+ Add Entry</button>
          <button class="btn gray" id="exportCSV">‚¨áÔ∏è Export CSV</button>
          <input id="csvFile" type="file" accept=".csv" style="display:none" />
          <button class="btn gray" id="importCSV">‚¨ÜÔ∏è Import CSV</button>
          <button class="btn gray" id="downloadPDF">‚¨áÔ∏è Save PDF</button>
        </div>

        <div class="stats">
          <div class="stat"><div class="label">Cash In</div><div class="value" id="statIn">0</div></div>
          <div class="stat"><div class="label">Cash Out</div><div class="value" id="statOut">0</div></div>
          <div class="stat"><div class="label">Net</div><div class="value" id="statNet">0</div></div>
        </div>

        <div class="filters">
          <select class="filter" id="fType">
            <option value="">Types: All</option>
            <option value="in">Cash In</option>
            <option value="out">Cash Out</option>
          </select>
          <select class="filter" id="fContact"><option value="">Contacts: All</option></select>
          <select class="filter" id="fMember"><option value="">Members: All</option></select>
          <select class="filter" id="fMode">
            <option value="">Payment Modes: All</option>
            <option>Cash</option><option>Online</option>
          </select>
          <select class="filter" id="fCategory">
            <option value="">Categories: All</option>
            <option>Sales</option><option>Purchase</option><option>Expense</option><option>Salary</option><option>Other</option>
          </select>
        </div>

        <div id="entriesWrap" class="card panel" style="padding:0"></div>
      </section>

      <!-- USERS PAGE -->
      <section id="pageUsers" class="hidden">
        <div class="card panel">
          <h3 style="margin:0 0 10px">User Management</h3>
          <div class="grid" style="grid-template-columns:1fr 1fr">
            <div class="field"><label>Full Name</label><input id="userFull" placeholder="Full name"/></div>
            <div class="field"><label>Username</label><input id="userName" placeholder="username"/></div>
            <div class="field"><label>Password</label><input id="userPass" type="password" placeholder="password"/></div>
            <div class="field"><label>Role</label>
              <select id="userRole"><option>Owner</option><option>Admin</option><option>Staff</option></select>
            </div>
            <div class="field" style="grid-column:1/-1">
              <label>Book Access (multi-select)</label>
              <select id="userBooks" multiple size="6" style="width:100%;background:#fff;color:#0f172a;border:1px solid var(--line);border-radius:10px;padding:8px"></select>
              <div class="meta">Leave empty to allow ALL books</div>
            </div>
          </div>
          <div class="toolbar" style="margin-top:10px">
            <button class="btn primary" id="addUser">Add / Update User</button>
          </div>
          <div id="userList" style="margin-top:14px"></div>
        </div>
      </section>

      <!-- BACKUP / RESTORE -->
      <section id="pageBackup" class="hidden">
        <div class="card panel">
          <h3 style="margin-top:0">Backup & Restore</h3>
          <p class="meta">Export your data as JSON and import on another system to sync.</p>
          <div class="toolbar" style="gap:8px">
            <button class="btn gray" id="exportBtn">‚¨áÔ∏è Export JSON</button>
            <button class="btn primary" id="importBtn">‚¨ÜÔ∏è Import JSON</button>
            <button class="btn red" id="wipeBtn">üßπ Clear Local Data</button>
            <input id="importFile" type="file" accept=".json" style="display:none"/>
          </div>
        </div>
      </section>

      <!-- PRINT AREA (unused now; we open separate window) -->
      <section id="printArea" class="hidden"></section>
    </div>
  </main>
</div>

<!-- ENTRY MODAL -->
<div id="modalEntry" class="modal">
  <div class="sheet">
    <h3 id="entryModalTitle" style="margin:0 0 10px">Add Entry</h3>
    <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
      <div class="field"><label>Date</label><input id="entryDate" type="text" placeholder="DD-MM-YYYY"/></div>
      <div class="field"><label>Amount</label><input id="entryAmount" type="number" step="0.01" /></div>
      <div class="field"><label>Type</label>
        <div class="toolbar">
          <button class="btn btn-green" id="typeIn">Cash In</button>
          <button class="btn btn-red" id="typeOut">Cash Out</button>
        </div>
      </div>
      <div class="field"><label>Details</label><input id="entryDetails"/></div>
      <div class="field"><label>Contact</label><input id="entryContact"/></div>
      <div class="field"><label>Category</label><input id="entryCategory" placeholder="Sales / Expense / etc."/></div>
      <div class="field"><label>Mode</label>
        <div class="toolbar">
          <button class="btn btn-blue" id="modeCash">Cash</button>
          <button class="btn btn-purple" id="modeOnline">Online</button>
        </div>
      </div>
      <div class="field"><label>Bill/Ref</label><input id="entryBill"/></div>
    </div>
    <div class="toolbar" style="margin-top:12px;justify-content:flex-end">
      <button class="btn gray" onclick="closeModal('modalEntry')">Cancel</button>
      <button class="btn btn-save" id="saveEntry">Save</button>
    </div>
  </div>
</div>


<!-- üîπ Firebase SDK (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

<!-- üîπ Firebase Init + Helpers (no change to your app logic) -->
<script>
  // Your real Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBl4tyLgSNOWBEXPJghnrIxmetfX9SsscY",
    authDomain: "qasim-cashbook.firebaseapp.com",
    projectId: "qasim-cashbook",
    storageBucket: "qasim-cashbook.appspot.com",
    messagingSenderId: "46440516489",
    appId: "1:46440516489:web:bc76ce54c0de22f44cef58",
    measurementId: "G-P5V2Z5QW42"
  };

  firebase.initializeApp(firebaseConfig);
  const fdb = firebase.firestore();

  // Auth: make sure we are signed in (anonymous)
  let _authResolve;
  const authReady = new Promise(res => (_authResolve = res));
  firebase.auth().onAuthStateChanged(u => {
    if (!u) { firebase.auth().signInAnonymously().catch(console.error); }
    if (u) { _authResolve && _authResolve(u); }
  });

  function withAuthSync(task){
    return authReady.then(() => { try { return task(); } catch(e){ console.error(e); } });
  }

  // --- Firestore helpers ---
  function saveUserFS(user){ return fdb.collection("users").doc(user.username).set(user); }
  function saveBusinessFS(biz){ return fdb.collection("businesses").doc(biz.id).set({ id: biz.id, name: biz.name }); }
  function saveBookFS(bizId, book){ return fdb.collection("businesses").doc(bizId).collection("books").doc(book.id).set({ id: book.id, name: book.name, updatedAt: book.updatedAt }); }
  function saveEntryFS(bizId, bookId, entry){ return fdb.collection("businesses").doc(bizId).collection("books").doc(bookId).collection("entries").doc(entry.id).set(entry); }
  function logAuditFS(action, detail, user){ return fdb.collection("audit").add({ ts: Date.now(), user, action, detail }); }

  function syncDBToFS(){
    try{
      if (Array.isArray(window.users)) {
        window.users.forEach(u => { try{ saveUserFS(u); }catch(e){} });
      }
      if (window.db && Array.isArray(window.db.businesses)) {
        window.db.businesses.forEach(biz => {
          try{ saveBusinessFS(biz); }catch(e){}
          (biz.books||[]).forEach(book => {
            try{ saveBookFS(biz.id, book); }catch(e){}
            (book.entries||[]).forEach(entry => {
              try{ saveEntryFS(biz.id, book.id, entry); }catch(e){}
            });
          });
        });
      }
    }catch(err){ console.error('Sync error', err); }
  }
</script>

<script>
/* ========= PERSISTENCE ========= */
const KEY = 'cashbook:data:v1';
const AUTH = 'cashbook:users:v1';
function loadDB(){ try{ return JSON.parse(localStorage.getItem(KEY)); }catch(e){ return null; } }
function saveDB(){ try{ localStorage.setItem(KEY, JSON.stringify(db)); }catch(e){} }
function loadUsers(){ try{ return JSON.parse(localStorage.getItem(AUTH))||[]; }catch(e){ return []; } }
function saveUsers(){ try{ localStorage.setItem(AUTH, JSON.stringify(users)); }catch(e){} }
const uid = ()=> 'id_'+Math.random().toString(36).slice(2,9);

/* ========= INITIAL DATA ========= */
function seedDB(){
  return {
    businesses: [{ id:'biz_'+uid(), name:'My Business', books:[{ id:'book_'+uid(), name:'General', entries:[], createdAt:Date.now(), updatedAt:Date.now() }] }],
    audit: []
  };
}
let db = loadDB() || seedDB();
let users = loadUsers();
if(users.length===0){ users.push({username:'admin', pass:'admin', full:'Administrator', role:'Owner', books:[]}); saveUsers(); }
let currentUser = null;
let activeBizId = db.businesses[0].id;
let activeBookId = db.businesses[0].books[0].id;
let entryType = 'in';
let entryMode = 'Cash';
let editEntryId = null;
let filterStart=''; let filterEnd='';
let fType=''; let fContact=''; let fMember=''; let fMode=''; let fCategory='';

const esc = s=> String(s??'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const fmt = n=> Number(n||0).toLocaleString();
function parseAnyDate(s){
  if(!s) return null;
  if(/^\d{2}-\d{2}-\d{4}$/.test(s)){ const [d,m,y]=s.split('-').map(Number); return new Date(y,m-1,d); }
  if(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(s)) return new Date(s);
  if(/\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s+'T00:00');
  const d=new Date(s); return isNaN(d)?null:d;
}
const fmtDate = s=>{ const d=parseAnyDate(s); if(!d) return s||''; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return `${dd}-${mm}-${yy}`; };

/* ========= NAV ========= */
function setActiveNav(id){ ['navBooks','navEntries','navUsers','navBackup'].forEach(n=>{ const el=document.getElementById(n); if(el) el.classList.toggle('active', n===id); }); }
function showPage(id){ ['pageBooks','pageEntries','pageUsers','pageBackup'].forEach(i=> document.getElementById(i).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }

/* ========= LOGIN ========= */
function showApp(){ document.getElementById('loginWrap').style.display='none'; document.getElementById('app').style.display='grid'; }
function showLogin(){ document.getElementById('loginWrap').style.display='flex'; document.getElementById('app').style.display='none'; }
function tryStart(){
  try{
    if(!Array.isArray(db?.businesses) || db.businesses.length===0){ db = seedDB(); saveDB(); }
    if(!Array.isArray(users) || users.length===0){ users=[{username:'admin', pass:'admin', full:'Administrator', role:'Owner', books:[]}]; saveUsers(); }
  }catch(e){}
  showLogin();
  const onKey = (ev)=>{ if(ev.key==='Enter'){ const btn=document.getElementById('loginBtn'); if(btn) btn.click(); } };
  document.getElementById('loginUser').addEventListener('keydown', onKey);
  document.getElementById('loginPass').addEventListener('keydown', onKey);

  const B=(id,fn)=>{ const el=document.getElementById(id); if(el) el.onclick=fn; };
  B('navBooks',   ()=>{ setActiveNav('navBooks');   showPage('pageBooks');   renderBooks(); });
  B('navEntries', ()=>{ setActiveNav('navEntries'); showPage('pageEntries'); renderEntries(); });
  B('navUsers',   ()=>{ setActiveNav('navUsers');   showPage('pageUsers');   renderUsers(); });
  B('navBackup',  ()=>{ setActiveNav('navBackup');  showPage('pageBackup');  });
}
function doLogin(){
  try{
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value;
    if(!Array.isArray(users) || users.length===0){ users=[{username:'admin', pass:'admin', full:'Administrator', role:'Owner', books:[]}]; saveUsers(); }
    let user = users.find(x=>x.username===u && x.pass===p);
    if(!user && u==='admin' && p==='admin'){ user = {username:'admin', pass:'admin', full:'Administrator', role:'Owner', books:[]}; users.push(user); saveUsers(); }
    if(!user){ alert('Invalid credentials'); return false; }
    currentUser = user;
    document.getElementById('welcomeText').textContent = `Welcome ${user.full||user.username}`;
    document.getElementById('roleChip').innerHTML = `Your Role: <strong>${user.role}</strong>`;
    showApp(); hydrate(); return true;
  }catch(e){ alert('Login error: '+e.message); return false; }
}
document.getElementById('loginBtn').onclick = doLogin;
document.getElementById('resetAppLink').onclick = (e)=>{
  e.preventDefault();
  try{
    localStorage.removeItem(KEY); localStorage.removeItem(AUTH);
    db = seedDB(); users=[{username:'admin', pass:'admin', full:'Administrator', role:'Owner', books:[]}];
    saveDB(); saveUsers();
    alert('Reset complete. Use admin/admin.');
  }catch(err){ alert('Reset failed: '+err.message); }
};

/* ========= BUSINESS / BOOKS ========= */
function getBiz(){ return db.businesses.find(b=>b.id===activeBizId); }
function getBook(){ const b=getBiz(); return b? b.books.find(x=>x.id===activeBookId): null; }

function renderBusinesses(){
  const sel = document.getElementById('businessSwitcher'); sel.innerHTML='';
  db.businesses.forEach(b=>{ const o=document.createElement('option'); o.value=b.id; o.textContent=b.name; sel.appendChild(o); });
  if(!activeBizId) activeBizId = db.businesses[0]?.id;
  sel.value = activeBizId;
}

function renderBooks(){
  const q = document.getElementById('searchBooks').value?.toLowerCase()||'';
  const wrap = document.getElementById('booksList'); wrap.innerHTML='';
  const biz = getBiz(); if(!biz){ wrap.innerHTML='<div class="card">No business</div>'; return; }

  // Auto-create a default book if none
  if(!Array.isArray(biz.books) || biz.books.length===0){
    const id='book_'+uid();
    const newBook={id, name:'New Book', entries:[], createdAt:Date.now(), updatedAt:Date.now()};
    biz.books=[newBook]; activeBookId = id; saveDB();
    setActiveNav('navEntries'); showPage('pageEntries'); renderEntries();
    return;
  }

  // Access control
  let books = [...biz.books];
  if(currentUser && Array.isArray(currentUser.books) && currentUser.books.length){ books = books.filter(b=> currentUser.books.includes(b.id)); }
  const filtered = books.filter(b=> b.name.toLowerCase().includes(q));
  if(!filtered.length){ wrap.innerHTML = '<div class="card">No books. Create one.</div>'; }
  else {
    filtered.forEach(b=>{
      const el = document.createElement('div');
      el.className='card panel';
      el.innerHTML = `<div>
        <div class="book-title" data-open="${b.id}">${esc(b.name)}</div>
        <div class="meta">Entries: ${b.entries?.length||0}</div>
        <div class="toolbar" style="gap:6px;margin-top:8px">
          <button class="btn" data-open="${b.id}">Open</button>
          <button class="btn gray" data-edit="${b.id}">Edit</button>
          <button class="btn red" data-del="${b.id}">Delete</button>
        </div>
      </div>`;
      wrap.appendChild(el);
    });
  }
  const sel = document.getElementById('bookSelector'); sel.innerHTML='';
  books.forEach(b=>{ const o=document.createElement('option'); o.value=b.id; o.textContent=b.name; sel.appendChild(o); });
  sel.value = activeBookId || (books[0]?.id||'');
  if(sel.value) activeBookId = sel.value;

  // open handlers for any [data-open]
  wrap.querySelectorAll('[data-open]').forEach(btn=>{
    btn.onclick = ()=>{ activeBookId = btn.getAttribute('data-open'); setActiveNav('navEntries'); showPage('pageEntries'); renderEntries(); };
  });
  // book edit/delete
  wrap.querySelectorAll('button[data-edit]').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute('data-edit');
      const biz = getBiz(); if(!biz) return;
      const book = biz.books.find(x=>x.id===id); if(!book) return;
      const name = prompt('New book name:', book.name); if(!name) return;
      book.name = name; book.updatedAt=Date.now(); saveDB(); renderBooks();
    };
  });
  wrap.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute('data-del');
      const biz = getBiz(); if(!biz) return;
      const book = biz.books.find(x=>x.id===id); if(!book) return;
      if(!confirm('Delete book "'+book.name+'"?')) return;
      biz.books = biz.books.filter(x=>x.id!==id);
      if(activeBookId===id){ activeBookId = biz.books.length? biz.books[biz.books.length-1].id : ''; }
      saveDB(); renderBooks(); if(activeBookId){ setActiveNav('navEntries'); showPage('pageEntries'); renderEntries(); }
    };
  });
}

document.getElementById('addBusinessBtn').onclick = ()=>{
  const name = prompt('Business name?'); if(!name) return;
  const id = 'biz_'+uid(); db.businesses.push({id, name, books: []}); activeBizId = id; saveDB();
  renderBusinesses(); renderBooks(); showPage('pageBooks');
};
document.getElementById('renameBusinessBtn').onclick = ()=>{
  const biz = getBiz(); if(!biz) return alert('No business selected');
  const name = prompt('New business name:', biz.name); if(!name) return;
  biz.name = name; saveDB(); renderBusinesses(); renderBooks(); renderEntries();
};
document.getElementById('deleteBusinessBtn').onclick = ()=>{
  const biz = getBiz(); if(!biz) return alert('No business selected');
  if(!confirm('Delete business "'+biz.name+'" and all its books?')) return;
  db.businesses = db.businesses.filter(b=>b.id!==biz.id);
  if(db.businesses.length===0){
    const nb={ id:'biz_'+uid(), name:'My Business', books:[{ id:'book_'+uid(), name:'General', entries:[], createdAt:Date.now(), updatedAt:Date.now() }] };
    db.businesses.push(nb);
  }
  activeBizId = db.businesses[db.businesses.length-1].id;
  saveDB(); renderBusinesses(); renderBooks(); setActiveNav('navEntries'); showPage('pageEntries'); renderEntries();
};
document.getElementById('businessSwitcher').onchange = (e)=>{
  activeBizId=e.target.value;
  const biz=getBiz(); if(biz && biz.books && biz.books.length){ activeBookId=biz.books[biz.books.length-1].id; }
  renderBooks(); setActiveNav('navEntries'); showPage('pageEntries'); renderEntries();
};

/* ========= USERS ========= */
function populateUserBooksMulti(){
  const biz = getBiz(); if(!biz) return;
  const sel = document.getElementById('userBooks'); sel.innerHTML='';
  biz.books.forEach(b=>{ const o=document.createElement('option'); o.value=b.id; o.textContent=b.name; sel.appendChild(o); });
}
document.getElementById('addUser').onclick = ()=>{
  const full = document.getElementById('userFull').value.trim();
  const username = document.getElementById('userName').value.trim();
  const pass = document.getElementById('userPass').value;
  const role = document.getElementById('userRole').value;
  const booksSel = Array.from(document.getElementById('userBooks').selectedOptions).map(o=>o.value);
  if(!username || !pass) return alert('Username & Password required');
  const existing = users.find(u=>u.username===username);
  const obj = {username, pass, full, role, books: booksSel};
  if(existing){ Object.assign(existing, obj); } else users.push(obj);
  saveUsers(); renderUsers();
};
function renderUsers(){
  populateUserBooksMulti();
  const box = document.getElementById('userList');
  if(!users.length){ box.innerHTML='<div class="card">No users yet.</div>'; return; }
  box.innerHTML = users.map(u=>`<div class="card" style="margin:6px 0">
    <div><b>${esc(u.full||u.username)}</b> <span class="meta">(${u.role})</span></div>
    <div class="meta">Books: ${u.books?.length? u.books.length+' selected' : 'All'}</div>
  </div>`).join('');
}

/* ========= ENTRIES ========= */
function getFilteredEntries(book){
  const q = document.getElementById('searchEntries').value?.toLowerCase()||'';
  const base = book.entries.filter(e=> !filterStart && !filterEnd ? true : inDateRange(e.date));
  return base.filter(e=>{
    const ty = String(e.type||'').toLowerCase();
    if (fType && ty !== fType) return false;
    if (fContact && (String(e.contact||'') !== fContact)) return false;
    if (fMode && (String(e.mode||'') !== fMode)) return false;
    if (fCategory && (String(e.category||'') !== fCategory)) return false;
    if (fMember && (String(e.createdBy||'') !== fMember)) return false;
    return (`${e.details} ${e.amount}`.toLowerCase().includes(q));
  });
}
function inDateRange(entryDate){
  const d=parseAnyDate(entryDate); if(!d) return false;
  const s=filterStart?parseAnyDate(filterStart):null;
  const e=filterEnd?parseAnyDate(filterEnd):null;
  if(s && d< new Date(s.getFullYear(),s.getMonth(),s.getDate())) return false;
  if(e && d> new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59)) return false;
  return true;
}
function populateEntryFilters(){
  const book = getBook(); if(!book) return;
  const contacts = Array.from(new Set(book.entries.map(e=>e.contact).filter(Boolean))).sort();
  const members  = Array.from(new Set(book.entries.map(e=>e.createdBy).filter(Boolean))).sort();
  const categories = Array.from(new Set(book.entries.map(e=>e.category).filter(Boolean))).sort();
  const fc = document.getElementById('fContact');
  const fm = document.getElementById('fMember');
  const fcat = document.getElementById('fCategory');
  if(fc){ const cur=fc.value; fc.innerHTML = '<option value=\"\">Contacts: All</option>' + contacts.map(c=>`<option>${c}</option>`).join(''); fc.value = cur||''; }
  if(fm){ const cur=fm.value; fm.innerHTML = '<option value=\"\">Members: All</option>' + members.map(m=>`<option>${m}</option>`).join(''); fm.value = cur||''; }
  if(fcat){
    const cur=fcat.value; const base=['Sales','Purchase','Expense','Salary','Other'];
    const dyn=categories.filter(c=>!base.includes(c));
    fcat.innerHTML = '<option value=\"\">Categories: All</option>' + [...base,...dyn].map(c=>`<option>${c}</option>`).join('');
    fcat.value = cur||'';
  }
}
function renderEntries(){
  const book = getBook();
  if(!book){ document.getElementById('entriesWrap').innerHTML='<div class="card">Select a book first</div>'; return; }
  populateEntryFilters();
  const rows = getFilteredEntries(book);
  const sumIn = rows.filter(e=>String(e.type||'').toLowerCase()==='in').reduce((a,b)=>a+Number(b.amount||0),0);
  const sumOut= rows.filter(e=>String(e.type||'').toLowerCase()==='out').reduce((a,b)=>a+Number(b.amount||0),0);
  document.getElementById('statIn').textContent = fmt(sumIn);
  document.getElementById('statOut').textContent= fmt(sumOut);
  document.getElementById('statNet').textContent = fmt(sumIn - sumOut);

  let running=0;
  const body = rows.map(e=>{
    running += (String(e.type||'').toLowerCase()==='in'? Number(e.amount||0) : -Number(e.amount||0));
    return `<tr>
      <td>${fmtDate(e.date)}</td>
      <td>${esc(e.details||'')}</td>
      <td>${esc(e.contact||'')}</td>
      <td>${esc(e.category||'')}</td>
      <td>${esc(e.mode||'')}</td>
      <td class="amount-in">${String(e.type||'').toLowerCase()==='in'?fmt(e.amount):''}</td>
      <td class="amount-out">${String(e.type||'').toLowerCase()==='out'?fmt(e.amount):''}</td>
      <td>${esc(e.createdBy||'')}</td>
      <td class="right">${fmt(running)}</td>
      <td id="act_${e.id}">
        <div class="toolbar" style="gap:6px">
          <button class="btn gray" onclick="showMoveInline('${e.id}')">Move</button>
          <button class="btn" onclick="editEntry('${e.id}')">Edit</button>
          <button class="btn red" onclick="deleteEntry('${e.id}')">Delete</button>
        </div>
      </td>
    </tr>`;
  }).join('');

  const html = `<table class="table">
    <thead><tr>
      <th>Date</th><th>Remark</th><th>Contact</th><th>Category</th><th>Mode</th>
      <th>Cash In</th><th>Cash Out</th><th>Entry By</th><th>Running</th><th>Actions</th>
    </tr></thead>
    <tbody>${body||'<tr><td colspan="10" class="meta">No entries</td></tr>'}</tbody>
  </table>`;
  document.getElementById('entriesWrap').innerHTML = html;
}
function getMoveTargets(){ const biz = getBiz(); return biz? biz.books.filter(b=> b.id!==activeBookId): []; }
function showMoveInline(id){
  const cell = document.getElementById('act_'+id); if(!cell) return;
  const targets = getMoveTargets();
  if(!targets.length){ cell.innerHTML = '<span class="meta">No other books</span>'; return; }
  const selId = 'mv_'+id;
  cell.innerHTML = `
    <div class="toolbar" style="gap:6px">
      <select id="${selId}" class="filter" style="min-width:180px">
        ${targets.map(x=>`<option value="${x.id}">${esc(x.name)}</option>`).join('')}
      </select>
      <button class="btn primary" onclick="confirmMoveEntry('${id}','${selId}')">Confirm</button>
      <button class="btn" onclick="resetActionsCell('${id}')">Cancel</button>
    </div>`;
}
function resetActionsCell(id){
  const cell = document.getElementById('act_'+id); if(cell) cell.innerHTML = `<div class="toolbar" style="gap:6px">
          <button class="btn gray" onclick="showMoveInline('${id}')">Move</button>
          <button class="btn" onclick="editEntry('${id}')">Edit</button>
          <button class="btn red" onclick="deleteEntry('${id}')">Delete</button>
        </div>`;
}
function confirmMoveEntry(id, selId){
  const sel = document.getElementById(selId); const targetId = sel && sel.value;
  if(!targetId) return alert('Select target book');
  moveEntry(id, targetId);
}
function editEntry(id){ const book=getBook(); const e=book.entries.find(x=>x.id===id); if(!e) return; entryType = (String(e.type||'in').toLowerCase()==='out'?'out':'in'); entryMode = e.mode || 'Cash'; openEntryModal(entryType, e); }
function deleteEntry(id){
  const book=getBook(); const e=book.entries.find(x=>x.id===id); if(!e) return;
  if(!confirm('Delete this entry?')) return;
  book.entries = book.entries.filter(x=>x.id!==id);
  logAudit('delete', `Entry ${e.details||''} deleted from ${getBook().name}`);
  saveDB(); renderEntries();
}
function moveEntry(id, forcedTargetId){
  const book=getBook(); if(!book) return;
  const e=book.entries.find(x=>x.id===id); if(!e) return;
  const sel = document.getElementById('mv_'+id); const targetId = forcedTargetId || (sel && sel.value);
  if(!targetId) return alert('Select target book');
  const idx = book.entries.findIndex(x=>x.id===id);
  const obj = book.entries.splice(idx,1)[0];
  const target = getBiz().books.find(b=>b.id===targetId);
  if(!target) return alert('Target not found');
  target.entries.push(obj);
  logAudit('move', `Entry ${e.details||''} moved from ${getBook().name} to ${target.name}`);
  saveDB(); renderEntries();
}

/* ========= ENTRY MODAL ========= */
function setTypeButtons(){
  const i=document.getElementById('typeIn'), o=document.getElementById('typeOut');
  const mc=document.getElementById('modeCash'), mo=document.getElementById('modeOnline');
  // Clear solids first
  i.classList.remove('btn-solid-green'); o.classList.remove('btn-solid-red');
  mc.classList.remove('btn-solid-blue'); mo.classList.remove('btn-solid-purple');
  // Apply based on selection
  if(entryType==='in'){ i.classList.add('btn-solid-green'); }
  if(entryType==='out'){ o.classList.add('btn-solid-red'); }
  if(entryMode==='Cash'){ mc.classList.add('btn-solid-blue'); }
  if(entryMode==='Online'){ mo.classList.add('btn-solid-purple'); }
}
function openEntryModal(type, existing){
  entryType = type||'in'; entryMode='Cash'; setTypeButtons();
  const now = fmtDate(new Date().toISOString());
  document.getElementById('entryDate').value = existing?.date || now;
  document.getElementById('entryAmount').value = existing?.amount || '';
  document.getElementById('entryDetails').value = existing?.details || '';
  document.getElementById('entryContact').value = existing?.contact || '';
  document.getElementById('entryCategory').value = existing?.category || '';
  document.getElementById('entryBill').value = existing?.bill || '';
  editEntryId = existing?.id || null;
  document.getElementById('modalEntry').style.display='flex';
  setTypeButtons();
}
function closeModal(id){ document.getElementById(id).style.display='none'; }
function saveEntry(){
  const e = {
    id: editEntryId || uid(), type: entryType,
    date: document.getElementById('entryDate').value,
    amount: Number(document.getElementById('entryAmount').value||0),
    details: document.getElementById('entryDetails').value,
    contact: document.getElementById('entryContact').value,
    category: document.getElementById('entryCategory').value,
    mode: entryMode,
    bill: document.getElementById('entryBill').value,
    createdBy: currentUser?.full || currentUser?.username || ''
  };
  if(!e.amount) return alert('Enter amount');
  const book = getBook(); if(!book) return alert('Select a book');
  if(editEntryId){ const idx = book.entries.findIndex(x=>x.id===editEntryId); book.entries[idx] = e; logAudit('edit', `Entry ${e.details||''} edited in ${getBook().name}`); }
  else { book.entries.push(e); logAudit('add', `Entry ${e.details||''} added in ${getBook().name}`); }
  book.updatedAt=Date.now(); saveDB(); closeModal('modalEntry'); renderEntries();
}
document.getElementById('btnAddEntry').onclick = ()=> openEntryModal('in');
document.getElementById('saveEntry').onclick   = saveEntry;
document.getElementById('typeIn').onclick      = ()=>{ entryType='in'; setTypeButtons(); };
document.getElementById('typeOut').onclick     = ()=>{ entryType='out'; setTypeButtons(); };
document.getElementById('modeCash').onclick    = ()=>{ entryMode='Cash'; setTypeButtons(); };
document.getElementById('modeOnline').onclick  = ()=>{ entryMode='Online'; setTypeButtons(); };

/* ========= FILTERS + SEARCH ========= */
document.getElementById('bookSelector').onchange = (e)=>{ activeBookId=e.target.value; renderEntries(); };
document.getElementById('searchEntries').addEventListener('input', renderEntries);
document.getElementById('applyDate').onclick = ()=>{ filterStart=document.getElementById('dateFrom').value||''; filterEnd=document.getElementById('dateTo').value||''; renderEntries(); };
document.getElementById('clearDate').onclick = ()=>{ filterStart=''; filterEnd=''; document.getElementById('dateFrom').value=''; document.getElementById('dateTo').value=''; renderEntries(); };
document.getElementById('fType').onchange    = (e)=>{ fType=e.target.value; renderEntries(); };
document.getElementById('fContact').onchange = (e)=>{ fContact=e.target.value; renderEntries(); };
document.getElementById('fMember').onchange  = (e)=>{ fMember=e.target.value; renderEntries(); };
document.getElementById('fMode').onchange    = (e)=>{ fMode=e.target.value; renderEntries(); };
document.getElementById('fCategory').onchange= (e)=>{ fCategory=e.target.value; renderEntries(); };

/* ========= DATE PICKER ========= */
const _dp = { el:null, target:null, y:0, m:0 };
function _dp_pad(n){ return String(n).padStart(2,'0'); }
function _dp_monthName(m){ return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m]; }
function _dp_build(y,m){
  const first = new Date(y,m,1);
  const startDay = (first.getDay()+6)%7; // Monday=0
  const days = new Date(y, m+1, 0).getDate();
  let html = `<div class="dp-head">
    <div class="dp-nav">
      <button class="btn" onclick="_dp_prev()">‚óÄ</button>
      <button class="btn" onclick="_dp_next()">‚ñ∂</button>
    </div>
    <div><b>${_dp_monthName(m)} ${y}</b></div>
    <button class="btn gray" onclick="_dp_today()">Today</button>
  </div>`;
  html += `<div class="dp-grid">`;
  ['Mo','Tu','We','Th','Fr','Sa','Su'].forEach(d=> html += `<div class="dow">${d}</div>`);
  for(let i=0;i<startDay;i++) html += `<div></div>`;
  const today = new Date();
  for(let d=1; d<=days; d++){
    const isToday = d===today.getDate() && m===today.getMonth() && y===today.getFullYear();
    html += `<button class="${isToday?'dp-today':''}" onclick="_dp_pick(${y},${m},${d})">${d}</button>`;
  }
  html += `</div>`;
  return html;
}
function _dp_showFor(input){
  if(!_dp.el){
    _dp.el = document.createElement('div'); _dp.el.className='datepicker';
    document.body.appendChild(_dp.el);
    document.addEventListener('click', (ev)=>{
      if(!_dp.el) return;
      if(_dp.el.contains(ev.target)) return;
      if(ev.target===_dp.target) return;
      _dp.el.style.display='none';
    });
  }
  _dp.target = input;
  const now = parseAnyDate(input.value) || new Date();
  _dp.y = now.getFullYear(); _dp.m = now.getMonth();
  _dp.el.innerHTML = _dp_build(_dp.y, _dp.m);
  const r = input.getBoundingClientRect();
  _dp.el.style.left = (r.left) + 'px';
  _dp.el.style.top  = (r.bottom + 6) + 'px';
  _dp.el.style.display='block';
}
function _dp_pick(y,m,d){
  const val = _dp_pad(d)+'-'+_dp_pad(m+1)+'-'+y;
  if(_dp.target){ _dp.target.value = val; _dp.el.style.display='none'; }
}
function _dp_prev(){ _dp.m--; if(_dp.m<0){ _dp.m=11; _dp.y--; } _dp.el.innerHTML = _dp_build(_dp.y,_dp.m); }
function _dp_next(){ _dp.m++; if(_dp.m>11){ _dp.m=0; _dp.y++; } _dp.el.innerHTML = _dp_build(_dp.y,_dp.m); }
function _dp_today(){ const t=new Date(); _dp_pick(t.getFullYear(), t.getMonth(), t.getDate()); }
function attachDatePicker(id){
  const inp = document.getElementById(id);
  if(!inp) return;
  inp.addEventListener('focus', ()=> _dp_showFor(inp));
  inp.addEventListener('click', ()=> _dp_showFor(inp));
}
document.addEventListener('DOMContentLoaded', function(){
  tryStart();
  attachDatePicker('dateFrom');
  attachDatePicker('dateTo');
  attachDatePicker('entryDate');
});

/* ========= CSV / PDF ========= */
document.getElementById('exportCSV').onclick = ()=>{
  const book = getBook(); if(!book) return alert('Open a book first');
  const rows = getFilteredEntries(book);
  const sumIn = rows.filter(e=>String(e.type||'').toLowerCase()==='in').reduce((a,b)=>a+Number(b.amount||0),0);
  const sumOut= rows.filter(e=>String(e.type||'').toLowerCase()==='out').reduce((a,b)=>a+Number(b.amount||0),0);
  const net = sumIn - sumOut;
  const head = 'date,details,contact,category,mode,bill,amount,type,createdBy';
  const body = rows.map(r=>[
    fmtDate(r.date), (r.details||'').replaceAll(',', ' '), (r.contact||'').replaceAll(',', ' '),
    (r.category||'').replaceAll(',', ' '), (r.mode||'').replaceAll(',', ' '),
    (r.bill||'').replaceAll(',', ' '), r.amount, r.type, r.createdBy||''
  ].join(',')).join('\n');
  const summary = [
    'SUMMARY', `Total Cash In,${sumIn}`, `Total Cash Out,${sumOut}`, `Net Balance,${net}`, `Date Range,${fmtDate(filterStart||'')},${fmtDate(filterEnd||'')}`, ''
  ].join('\n');
  const csv = summary + '\n' + head + '\n' + body;
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download=(getBook().name||'book').replace(/\s+/g,'_')+'-filtered_with_summary.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200);
};

document.getElementById('importCSV').onclick = ()=> document.getElementById('csvFile').click();
document.getElementById('csvFile').onchange = (ev)=>{
  const file = ev.target.files && ev.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const lines = String(reader.result).split(/\r?\n/).filter(Boolean);
      const head = lines.shift().split(',').map(x=>x.trim().toLowerCase());
      const req = ['date','details','contact','category','mode','bill','amount','type'];
      const ok = req.every(k=>head.includes(k)); if(!ok) return alert('Invalid CSV header. Required: '+req.join(', '));
      const idx = Object.fromEntries(req.map(k=>[k, head.indexOf(k)]));
      const book=getBook(); if(!book) return alert('Open a book first');
      let added=0;
      lines.forEach(line=>{
        const parts=line.split(',');
        book.entries.push({
          id: uid(), date: parts[idx.date], details: parts[idx.details], contact: parts[idx.contact] || '',
          category: parts[idx.category], mode: parts[idx.mode], bill: parts[idx.bill],
          amount: Number(parts[idx.amount]||0),
          type: (parts[idx.type]||'in').trim().toLowerCase()==='out'?'out':'in',
          createdBy: currentUser?.full || currentUser?.username || ''
        });
        added++;
      });
      saveDB(); renderEntries(); alert('Imported '+added+' rows');
    }catch(err){ alert('CSV import failed: '+err.message); }
    ev.target.value='';
  };
  reader.readAsText(file);
};

document.getElementById('downloadPDF').onclick = ()=>{
  const book = getBook(); if(!book) return alert('Open a book first');
  const rows = getFilteredEntries(book);
  const sumIn = rows.filter(e=>String(e.type||'').toLowerCase()==='in').reduce((a,b)=>a+Number(b.amount||0),0);
  const sumOut= rows.filter(e=>String(e.type||'').toLowerCase()==='out').reduce((a,b)=>a+Number(b.amount||0),0);
  const net = sumIn - sumOut;

  let running=0;
  const body = rows.map(e=>{
    running += (String(e.type||'').toLowerCase()==='in'? Number(e.amount||0) : -Number(e.amount||0));
    return `<tr>
      <td>${fmtDate(e.date)}</td>
      <td>${esc(e.details||'')}</td>
      <td>${esc(e.contact||'')}</td>
      <td>${esc(e.category||'')}</td>
      <td>${esc(e.mode||'')}</td>
      <td>${String(e.type||'').toLowerCase()==='in'?fmt(e.amount):''}</td>
      <td>${String(e.type||'').toLowerCase()==='out'?fmt(e.amount):''}</td>
      <td>${esc(e.createdBy||'')}</td>
      <td>${fmt(running)}</td>
    </tr>`;
  }).join('');

  const htmlDoc = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Report ‚Äî ${esc(getBiz().name)} ‚Äî ${esc(book.name)}</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:28px;color:#0f172a;background:#fff}
    h2{margin:0 0 10px}
    .meta{color:#475569;margin-bottom:6px}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:18px 0 10px}
    .stat{border-radius:16px;padding:18px 18px;min-height:110px;box-shadow:0 8px 20px rgba(15,23,42,.08);color:#fff}
    .stat .label{font-size:14px;letter-spacing:.2px;opacity:.95;margin-bottom:8px}
    .stat .value{font-size:34px;font-weight:900;line-height:1.1}
    .stat-in{background:linear-gradient(135deg,#16a34a,#22c55e)}
    .stat-out{background:linear-gradient(135deg,#ef4444,#f87171)}
    .stat-net{background:linear-gradient(135deg,#2563eb,#38bdf8)}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{border-bottom:1px solid #e5e7eb;padding:10px;text-align:left;font-size:14px}
    th{background:#f8fafc}
    .toolbar{position:sticky;top:0;background:#fff;padding:8px 0 12px;margin-bottom:8px}
    .btn{border:1px solid #e5e7eb;background:#f8fafc;padding:10px 14px;border-radius:10px;cursor:pointer}
  </style></head><body>
  <div class="toolbar"><button class="btn" onclick="window.print()">Print / Save as PDF</button></div>
  <h2>${esc(getBiz().name)} ‚Äî ${esc(book.name)}</h2>
  <div class="meta">Date Range: ${fmtDate(filterStart||'')} ‚Äî ${fmtDate(filterEnd||'')}</div>
  <div class="stats">
    <div class="stat stat-in"><div class="label">Cash In</div><div class="value">${fmt(sumIn)}</div></div>
    <div class="stat stat-out"><div class="label">Cash Out</div><div class="value">${fmt(sumOut)}</div></div>
    <div class="stat stat-net"><div class="label">Net</div><div class="value">${fmt(net)}</div></div>
  </div>
  <table>
    <thead><tr>
      <th>Date</th><th>Remark</th><th>Contact</th><th>Category</th><th>Mode</th>
      <th>Cash In</th><th>Cash Out</th><th>Entry By</th><th>Running</th>
    </tr></thead>
    <tbody>${body||'<tr><td colspan="9">No entries</td></tr>'}</tbody>
  </table>
  
<!-- üîπ Firebase Wrappers (do not change your functions, just extend them) -->
<script>
(function(){
  // Wrap saveDB to also sync to Firestore after local save
  if (typeof window.saveDB === 'function') {
    const _saveDB = window.saveDB;
    window.saveDB = function(){
      try { _saveDB(); } finally {
        withAuthSync(syncDBToFS);
      }
    };
  }

  // Wrap saveUsers similarly
  if (typeof window.saveUsers === 'function') {
    const _saveUsers = window.saveUsers;
    window.saveUsers = function(){
      try { _saveUsers(); } finally {
        withAuthSync(() => {
          if (Array.isArray(window.users)) window.users.forEach(u => saveUserFS(u));
        });
      }
    };
  }

  // Mirror audit logs to Firestore
  if (typeof window.logAudit === 'function') {
    const _logAudit = window.logAudit;
    window.logAudit = function(action, detail){
      try { _logAudit(action, detail); } finally {
        withAuthSync(() => logAuditFS(action, detail, (window.currentUser && window.currentUser.username) || ''));
      }
    };
  }

  // Initial push once auth is ready (keeps UI/logic unchanged)
  withAuthSync(syncDBToFS);
})();
</script>

</body></html>`;

  const w = window.open('', '_blank');
  if(!w){ alert('Popup blocked. Please allow popups for preview.'); return; }
  w.document.open(); w.document.write(htmlDoc); w.document.close();
};

/* ========= BACKUP & RESTORE ========= */
document.getElementById('exportBtn').onclick = ()=>{
  try{
    const payload = { version: 1, exportedAt: new Date().toISOString(), db, users };
    const a=document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}));
    a.download = 'cashbook_backup.json';
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),1200);
  }catch(err){ alert('Export failed: '+err.message); }
};
document.getElementById('importBtn').onclick = ()=> document.getElementById('importFile').click();
document.getElementById('importFile').onchange = (ev)=>{
  const file = ev.target.files && ev.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      if(!obj || !obj.db || !obj.users) throw new Error('Invalid backup file');
      db = obj.db; users = obj.users;
      saveDB(); saveUsers();
      alert('Import successful. Reloading...'); location.reload();
    }catch(err){ alert('Import failed: '+err.message); }
    ev.target.value='';
  };
  reader.readAsText(file);
};
// Clear ENTRIES only; keep businesses, books, and users intact
document.getElementById('wipeBtn').onclick = ()=>{
  if(!confirm('Clear ALL entries in all books? (Businesses, books, and users will be kept)')) return;
  try{
    const now = Date.now();
    if(!db || !Array.isArray(db.businesses)) return alert('No data found');
    db.businesses.forEach(b=>{
      if(Array.isArray(b.books)){
        b.books.forEach(book=>{
          book.entries = [];
          book.updatedAt = now;
        });
      }
    });
    saveDB();
    alert('Done: All entries cleared. Businesses, books, and users kept.');
    renderBooks();
    setActiveNav('navEntries'); showPage('pageEntries'); renderEntries();
  }catch(err){
    alert('Clear failed: '+err.message);
  }
};

/* ========= AUDIT ========= */
function logAudit(action, detail){
  try{
    db.audit = db.audit || [];
    db.audit.push({ id: uid(), ts: Date.now(), user: currentUser?.username||'', action, detail });
    if(db.audit.length > 2000) db.audit = db.audit.slice(-2000);
    saveDB();
  }catch(e){}
}

/* ========= HYDRATE / LOGOUT ========= */
function hydrate(){
  renderBusinesses(); renderBooks();
  const biz=getBiz();
  if(biz && biz.books.length){ activeBookId=biz.books[biz.books.length-1].id; setActiveNav('navEntries'); showPage('pageEntries'); renderEntries(); }
  else { setActiveNav('navBooks'); showPage('pageBooks'); }
  renderUsers();
}
document.getElementById('logoutBtn').onclick = ()=>{
  try{ currentUser=null; }catch{}
  try{ history.replaceState(null,'',location.pathname); }catch{}
  showLogin();
};

/* ========= START ========= */
document.addEventListener('DOMContentLoaded', function(){
  tryStart();
  attachDatePicker('dateFrom');
  attachDatePicker('dateTo');
  attachDatePicker('entryDate');
});
</script>

<!-- üîπ Firebase Wrappers (do not change your functions, just extend them) -->
<script>
(function(){
  // Wrap saveDB to also sync to Firestore after local save
  if (typeof window.saveDB === 'function') {
    const _saveDB = window.saveDB;
    window.saveDB = function(){
      try { _saveDB(); } finally {
        withAuthSync(syncDBToFS);
      }
    };
  }

  // Wrap saveUsers similarly
  if (typeof window.saveUsers === 'function') {
    const _saveUsers = window.saveUsers;
    window.saveUsers = function(){
      try { _saveUsers(); } finally {
        withAuthSync(() => {
          if (Array.isArray(window.users)) window.users.forEach(u => saveUserFS(u));
        });
      }
    };
  }

  // Mirror audit logs to Firestore
  if (typeof window.logAudit === 'function') {
    const _logAudit = window.logAudit;
    window.logAudit = function(action, detail){
      try { _logAudit(action, detail); } finally {
        withAuthSync(() => logAuditFS(action, detail, (window.currentUser && window.currentUser.username) || ''));
      }
    };
  }

  // Initial push once auth is ready (keeps UI/logic unchanged)
  withAuthSync(syncDBToFS);
})();
</script>

</body>
</html>
